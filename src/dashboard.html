<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema Rural</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <a href="/">Sistema Rural</a>
            </div>
            <nav class="nav">
                <a href="/" class="nav-link">Home</a>
            </nav>
            <div class="auth-section">
                <div class="user-menu" id="userMenu">
                    <button class="user-avatar" id="userAvatar">
                        <span id="userInitial">U</span>
                    </button>
                    <div class="dropdown" id="userDropdown">
                        <a href="dashboard.html" class="dropdown-item active">
                            <span class="icon">üìä</span> Dashboard
                        </a>
                        <a href="mapeamento.html" class="dropdown-item">
                            <span class="icon">üó∫Ô∏è</span> Mapeamento
                        </a>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item logout-btn" id="logoutBtn">
                            <span class="icon">üö™</span> Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main dashboard-main">
        <div class="container">
            <!-- Dashboard Header -->
            <section class="dashboard-header">
                <h1>Dashboard</h1>
                <p>Vis√£o geral do seu sistema de propriedades rurais</p>
            </section>

            <!-- Quick Stats -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üè°</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalProperties">0</div>
                        <div class="stat-label">Propriedades</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìê</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalArea">0</div>
                        <div class="stat-label">Hectares</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìè</div>
                    <div class="stat-content">
                        <div class="stat-number" id="totalPerimeter">0</div>
                        <div class="stat-label">Km Per√≠metro</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-content">
                        <div class="stat-number" id="selectedCount">0</div>
                        <div class="stat-label">Selecionadas</div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="actions-section">
                <h2>A√ß√µes R√°pidas</h2>
                <div class="skills-grid">
                    <div class="skill-card">
                        <div class="skill-icon">üó∫Ô∏è</div>
                        <h3>Novo Mapeamento</h3>
                        <p>Desenhe uma nova propriedade no mapa interativo</p>
                        <a href="mapeamento.html" class="btn btn-primary">Come√ßar</a>
                    </div>
                    <div class="skill-card">
                        <div class="skill-icon">üìä</div>
                        <h3>Gerar Relat√≥rio</h3>
                        <p>Crie relat√≥rios profissionais das propriedades selecionadas</p>
                        <button class="btn btn-primary" id="generateReportBtn" disabled>
                            üìÑ Gerar Relat√≥rio
                        </button>
                    </div>
                    <div class="skill-card">
                        <div class="skill-icon">üìÅ</div>
                        <h3>Importar CSV</h3>
                        <p>Importe m√∫ltiplas propriedades via arquivo</p>
                        <button class="btn btn-outline" disabled>Em Breve</button>
                    </div>
                </div>
            </section>

            <!-- Properties Management -->
            <section class="properties-management">
                <div class="card">
                    <div class="card-header">
                        <div class="section-header">
                            <div>
                                <h2>Gerenciar Propriedades</h2>
                                <p class="section-subtitle">Selecione propriedades para incluir no relat√≥rio</p>
                            </div>
                            <div class="selection-controls">
                                <button class="btn btn-outline btn-small" id="selectAllBtn">
                                    ‚úÖ Selecionar Todas
                                </button>
                                <button class="btn btn-outline btn-small" id="clearSelectionBtn">
                                    ‚ùå Limpar Sele√ß√£o
                                </button>
                                <a href="mapeamento.html" class="btn btn-outline btn-small">Ver no Mapa</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="properties-list" id="propertiesList">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Carregando propriedades...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Selected Properties Summary -->
            <section class="selected-summary hidden" id="selectedSummary">
                <div class="card">
                    <div class="card-header">
                        <h3>Propriedades Selecionadas para Relat√≥rio</h3>
                    </div>
                    <div class="card-body">
                        <div class="selected-stats">
                            <div class="selected-stat">
                                <span class="stat-label">Total selecionadas:</span>
                                <span class="stat-value" id="selectedTotal">0</span>
                            </div>
                            <div class="selected-stat">
                                <span class="stat-label">√Årea total:</span>
                                <span class="stat-value" id="selectedArea">0 ha</span>
                            </div>
                            <div class="selected-stat">
                                <span class="stat-label">Per√≠metro total:</span>
                                <span class="stat-value" id="selectedPerimeter">0 km</span>
                            </div>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn-primary" id="confirmReportBtn">
                                üìÑ Confirmar e Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- System Info -->
            <section class="system-info">
                <div class="card">
                    <div class="card-header">
                        <h2>Informa√ß√µes do Sistema</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Vers√£o:</span>
                                <span class="info-value">1.2.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">√öltimo Acesso:</span>
                                <span class="info-value" id="lastAccess">Carregando...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status:</span>
                                <span class="info-value status-online">üü¢ Online</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Tecnologia:</span>
                                <span class="info-value">AWS Lambda + ReportLab + PDF</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modal (necess√°rio para components.js) -->
    <div class="modal-overlay hidden" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Sistema</h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p>Modal placeholder - n√£o deveria aparecer no dashboard</p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/auth.js"></script>
    <script src="js/components.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Enhanced Dashboard Controller with Server-side PDF Report Generation
        class Dashboard {
            constructor() {
                this.properties = [];
                this.selectedProperties = new Set();
                this.init();
            }

            init() {
                if (!auth.isAuthenticated() || !auth.isTokenValid()) {
                    window.location.href = '/';
                    return;
                }
                
                this.updateUserAvatar();
                this.loadDashboardData();
                this.updateLastAccess();
                this.bindEvents();
            }

            bindEvents() {
                // Selection controls
                document.getElementById('selectAllBtn').addEventListener('click', () => this.selectAll());
                document.getElementById('clearSelectionBtn').addEventListener('click', () => this.clearSelection());
                
                // Report generation
                document.getElementById('generateReportBtn').addEventListener('click', () => this.showReportPreview());
                document.getElementById('confirmReportBtn').addEventListener('click', () => this.generateReport());
                
                // Property list events will be bound when properties are rendered
            }

            updateUserAvatar() {
                if (window.userMenu) {
                    const userInfo = auth.getUserInfo();
                    if (userInfo) {
                        window.userMenu.updateUser(userInfo);
                    }
                } else {
                    setTimeout(() => this.updateUserAvatar(), 200);
                }
            }

            async loadDashboardData() {
                try {
                    await this.loadProperties();
                    this.updateStats();
                    this.renderPropertiesList();
                } catch (error) {
                    this.showDemoData();
                }
            }

            async loadProperties() {
                const token = auth.getToken();
                if (!token) throw new Error('No auth token');

                try {
                    const response = await fetch('https://nfvbev7jgc.execute-api.us-east-1.amazonaws.com/devops/properties', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.properties = data.properties || [];
                    } else {
                        this.properties = [];
                    }
                } catch (error) {
                    this.showDemoData();
                }
            }

            showDemoData() {
                this.properties = [
                    {
                        id: '1',
                        name: 'Fazenda Demo Norte',
                        type: 'fazenda',
                        area: 45.7,
                        perimeter: 2800,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'S√≠tio Exemplo Sul',
                        type: 'sitio',
                        area: 12.3,
                        perimeter: 1450,
                        createdAt: new Date(Date.now() - 86400000).toISOString()
                    },
                    {
                        id: '3',
                        name: 'Ch√°cara Demo',
                        type: 'chacara',
                        area: 8.5,
                        perimeter: 920,
                        createdAt: new Date(Date.now() - 172800000).toISOString()
                    }
                ];
                this.updateStats();
                this.renderPropertiesList();
            }

            updateStats() {
                const totalProperties = this.properties.length;
                const totalArea = this.properties.reduce((sum, p) => sum + (p.area || 0), 0);
                const totalPerimeter = this.properties.reduce((sum, p) => sum + (p.perimeter || 0), 0);
                const selectedCount = this.selectedProperties.size;

                document.getElementById('totalProperties').textContent = totalProperties;
                document.getElementById('totalArea').textContent = totalArea.toFixed(1);
                document.getElementById('totalPerimeter').textContent = (totalPerimeter / 1000).toFixed(1);
                document.getElementById('selectedCount').textContent = selectedCount;

                // Enable/disable report button
                const reportBtn = document.getElementById('generateReportBtn');
                reportBtn.disabled = selectedCount === 0;
                reportBtn.textContent = selectedCount > 0 ? 
                    `üìÑ Gerar Relat√≥rio (${selectedCount})` : 'üìÑ Gerar Relat√≥rio';
            }

            renderPropertiesList() {
                const container = document.getElementById('propertiesList');
                if (!container) return;
                
                if (this.properties.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üó∫Ô∏è</div>
                            <h3>Nenhuma propriedade cadastrada</h3>
                            <p>Comece criando sua primeira propriedade no mapeamento</p>
                            <a href="mapeamento.html" class="btn btn-primary">Criar Propriedade</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.properties.map(prop => `
                    <div class="property-item" data-property-id="${prop.id}">
                        <div class="property-selection">
                            <label class="checkbox-container">
                                <input type="checkbox" 
                                       class="property-checkbox" 
                                       data-property-id="${prop.id}"
                                       ${this.selectedProperties.has(prop.id) ? 'checked' : ''}>
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="property-content">
                            <div class="property-header">
                                <h4>${prop.name}</h4>
                                <span class="property-type">${this.capitalizeFirst(prop.type)}</span>
                            </div>
                            <div class="property-metrics">
                                <span>üìê ${prop.area} ha</span>
                                <span>üìè ${(prop.perimeter / 1000).toFixed(1)} km</span>
                            </div>
                            <div class="property-date">
                                Criado em ${new Date(prop.createdAt).toLocaleDateString('pt-BR')}
                            </div>
                        </div>
                        <div class="property-actions">
                            <button class="btn btn-small btn-outline" onclick="window.open('mapeamento.html', '_blank')">
                                üó∫Ô∏è Ver no Mapa
                            </button>
                        </div>
                    </div>
                `).join('');

                // Bind checkbox events
                container.querySelectorAll('.property-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        this.togglePropertySelection(e.target.dataset.propertyId, e.target.checked);
                    });
                });
            }

            togglePropertySelection(propertyId, selected) {
                if (selected) {
                    this.selectedProperties.add(propertyId);
                } else {
                    this.selectedProperties.delete(propertyId);
                }
                
                this.updateStats();
                this.updateSelectedSummary();
            }

            selectAll() {
                this.properties.forEach(prop => {
                    this.selectedProperties.add(prop.id);
                });
                
                // Update checkboxes
                document.querySelectorAll('.property-checkbox').forEach(checkbox => {
                    checkbox.checked = true;
                });
                
                this.updateStats();
                this.updateSelectedSummary();
            }

            clearSelection() {
                this.selectedProperties.clear();
                
                // Update checkboxes
                document.querySelectorAll('.property-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                this.updateStats();
                this.updateSelectedSummary();
            }

            updateSelectedSummary() {
                const summarySection = document.getElementById('selectedSummary');
                const selectedCount = this.selectedProperties.size;
                
                if (selectedCount === 0) {
                    summarySection.classList.add('hidden');
                    return;
                }
                
                summarySection.classList.remove('hidden');
                
                // Calculate totals for selected properties
                const selectedProps = this.properties.filter(p => this.selectedProperties.has(p.id));
                const totalArea = selectedProps.reduce((sum, p) => sum + p.area, 0);
                const totalPerimeter = selectedProps.reduce((sum, p) => sum + p.perimeter, 0);
                
                document.getElementById('selectedTotal').textContent = selectedCount;
                document.getElementById('selectedArea').textContent = `${totalArea.toFixed(1)} ha`;
                document.getElementById('selectedPerimeter').textContent = `${(totalPerimeter / 1000).toFixed(1)} km`;
            }

            showReportPreview() {
                if (this.selectedProperties.size === 0) {
                    if (window.toast) {
                        window.toast.show('Selecione pelo menos uma propriedade', 'warning');
                    }
                    return;
                }
                
                this.updateSelectedSummary();
                
                // Scroll to summary
                document.getElementById('selectedSummary').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'center'
                });
            }

            async generateReport() {
                const selectedProps = this.properties.filter(p => this.selectedProperties.has(p.id));
                
                if (selectedProps.length === 0) {
                    if (window.toast) {
                        window.toast.show('Nenhuma propriedade selecionada', 'error');
                    }
                    return;
                }

                const confirmBtn = document.getElementById('confirmReportBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = '‚è≥ Gerando relat√≥rio...';

                try {
                    // Chamar API Lambda para gerar PDF
                    const propertyIds = selectedProps.map(p => p.id);
                    
                    const response = await fetch('https://nfvbev7jgc.execute-api.us-east-1.amazonaws.com/devops/properties/report', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${auth.getToken()}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            propertyIds: propertyIds
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    
                    // Fazer download do PDF
                    this.downloadPDF(result.pdf, result.filename);
                    
                    if (window.toast) {
                        window.toast.show(`Relat√≥rio PDF gerado: ${result.filename}`, 'success');
                    }
                    
                } catch (error) {
                    console.error('Erro ao gerar relat√≥rio:', error);
                    if (window.toast) {
                        window.toast.show(`Erro ao gerar relat√≥rio: ${error.message}`, 'error');
                    }
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'üìÑ Confirmar e Gerar Relat√≥rio';
                }
            }

            // Fun√ß√£o auxiliar para download do PDF
            downloadPDF(pdfBase64, filename) {
                try {
                    // Converter base64 para blob
                    const byteCharacters = atob(pdfBase64);
                    const byteNumbers = new Array(byteCharacters.length);
                    
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'application/pdf' });
                    
                    // Criar link de download
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Limpar URL object
                    window.URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Erro ao fazer download do PDF:', error);
                    if (window.toast) {
                        window.toast.show('Erro ao fazer download do arquivo', 'error');
                    }
                }
            }

            updateLastAccess() {
                const now = new Date();
                const formatted = now.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const lastAccessEl = document.getElementById('lastAccess');
                if (lastAccessEl) {
                    lastAccessEl.textContent = formatted;
                }
            }

            capitalizeFirst(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new Dashboard();
            
            // Direct logout handler
            document.addEventListener('click', (e) => {
                if (e.target.closest('#logoutBtn') || e.target.closest('.logout-btn')) {
                    e.preventDefault();
                    auth.signOut();
                }
            });
        });
    </script>
</body>
</html>